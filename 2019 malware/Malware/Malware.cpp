#include <iostream>
#include <vector>

#define id 0
#define dir 1

using namespace std;

int main()
{

    int n, m;
    int j, k;
    int error = 0;
    char tmp, sample;
    cin >> n >> m;

    vector<vector<char>> Grid(n, vector<char>(n, '.'));
    bool Ispresent[10] = { false };
    vector<vector<char>> Instructions(m, vector<char>(2));
    vector<int> reps(m);

    for (int i = 0; i < n; i++) {
        for (int j = 0; j < n; j++) {
            cin >> tmp;
            if (tmp != '.') {
                Grid[i][j] = tmp;
                Ispresent[tmp - '0'] = true;
            }
        }
    }
    for (int i = 0; i < m; i++) {
        for (int j = 0; j < 2; j++) {
            cin >> tmp;
            Instructions[i][j] = tmp;
        }
        cin >> reps[i];
    }


    for (int i = 0; i < m; i++) {
        error = 0;
        sample = Instructions[i][id];


        if (reps[i] < 1) { //error 1
            cout << 1 << endl;
            continue;
        }
        else if (Ispresent[sample - '0'] == false) { // error 2
            cout << 2 << endl;
            continue;
        }

        for (j = 0; j < n; j++) {
            for (k = 0; k < n; k++) {
                if (Grid[j][k] == sample) {
                    error = 1;
                    break;
                }
            }
            if (error) break;
        }
        error = 0;
        switch (Instructions[i][dir])
        {
        case 'U':
            if (j - reps[i] < 0) {
                cout << 4 << endl; // errore 4
                break;
            }

            for (int l = 1; l <= reps[i]; l++) {
                if (Grid[j - l][k] != '.') {
                    cout << 3 << endl; // errore 3
                    error = 1;
                    break;
                }
            }
            if (error) break;

            Grid[j - reps[i]][k] = sample;
            Grid[j][k] = '.';
            cout << 0 << endl;

            break;

        case 'D':
            if (j + reps[i] >= n) {
                cout << 4 << endl; // errore 4
                break;
            }
            for (int l = 1; l <= reps[i]; l++) {
                if (Grid[j + l][k] != '.') {
                    cout << 3 << endl; // errore 3
                    error = 1;
                    break;
                }
            }
            if (error) break;

            Grid[j + reps[i]][k] = sample;
            Grid[j][k] = '.';
            cout << 0 << endl;
            break;

        case 'L':
            if (k - reps[i] < 0) {
                cout << 4 << endl; // errore 4
                break;
            }
            for (int l = 1; l <= reps[i]; l++) {
                if (Grid[j][k - l] != '.') {
                    cout << 3 << endl; // errore 3
                    error = 1;
                    break;
                }
            }
            if (error) break;

            Grid[j][k - reps[i]] = sample;
            Grid[j][k] = '.';
            cout << 0 << endl;
            break;

        case 'R':
            if (k + reps[i] >= 0) {
                cout << 4 << endl; // errore 4
                break;
            }
            for (int l = 1; l <= reps[i]; l++) {
                if (Grid[j][k + l] != '.') {
                    cout << 3 << endl; // errore 3
                    error = 1;
                    break;
                }
            }
            if (error) break;

            Grid[j][k + reps[i]] = sample;
            Grid[j][k] = '.';
            cout << 0 << endl;
            break;

        default:
            break;
        }


    }
    for (int i = 0; i < n; i++) {
        for (int j = 0; j < n; j++) {
            cout << Grid[i][j] << " ";
        }
        cout << endl;
    }


    return 0;
}